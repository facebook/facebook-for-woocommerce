name: Product Creation E2E Tests

on:
  # make this workflow reusable and take in marketplace version as input
  workflow_call:
    inputs:
        use-marketplace-version:
          description: 'Should this use marketplace version of the plugin'
          required: false
          type: boolean
          default: false
  workflow_dispatch:
    inputs:
        use-marketplace-version:
          description: 'Should this use marketplace version of the plugin'
          required: false
          type: boolean
          default: false
  pull_request:
    branches: [ main, master, develop ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: wordpress
          MYSQL_DATABASE: wordpress
          MYSQL_USER: wordpress
          MYSQL_PASSWORD: wordpress
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli, zip, gd, curl, dom, imagick, fileinfo, mbstring

      - name: Install and configure Nginx
        run: |
          sudo apt-get update
          sudo apt-get install -y nginx php8.1-fpm

          # Add hosts entry for whitelisted domain
          echo "127.0.0.1 wooc-local-test-sitecom.local" | sudo tee -a /etc/hosts
          echo "âœ… Added hosts entry for wooc-local-test-sitecom.local"

          # Stop default nginx
          sudo systemctl stop nginx

          # Create Nginx config for WordPress
          sudo tee /etc/nginx/sites-available/wordpress > /dev/null <<'EOF'
          server {
              listen 8080;
              server_name wooc-local-test-sitecom.local;
              root /tmp/wordpress;
              index index.php index.html;

              location / {
                  try_files $uri $uri/ /index.php?$args;
              }

              location ~ \.php$ {
                  include snippets/fastcgi-php.conf;
                  fastcgi_pass unix:/run/php/php8.1-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                  include fastcgi_params;
              }

              location ~ /\.ht {
                  deny all;
              }
          }
          EOF

          # Enable the site
          sudo ln -sf /etc/nginx/sites-available/wordpress /etc/nginx/sites-enabled/wordpress
          sudo rm -f /etc/nginx/sites-enabled/default

          # Test nginx config
          sudo nginx -t

      - name: Create WordPress test environment
        run: |
          # Create WordPress directory
          mkdir -p /tmp/wordpress
          cd /tmp/wordpress

          # Download WordPress
          curl -O https://wordpress.org/latest.tar.gz
          tar -xzf latest.tar.gz --strip-components=1

          # Create wp-config.php
          cp wp-config-sample.php wp-config.php
          sed -i "s/database_name_here/wordpress/" wp-config.php
          sed -i "s/username_here/wordpress/" wp-config.php
          sed -i "s/password_here/wordpress/" wp-config.php
          sed -i "s/localhost/127.0.0.1/" wp-config.php

          # Add debug and security settings
          cat >> wp-config.php << 'EOF'

          // Debug settings - EXPLICITLY set the log file path
          define('WP_DEBUG', true);
          define('WP_DEBUG_LOG', '/tmp/wordpress/wp-content/debug.log');
          define('WP_DEBUG_DISPLAY', false);
          @ini_set('error_log', '/tmp/wordpress/wp-content/debug.log');
          @ini_set('log_errors', 'On');

          // Security keys (for testing only)
          define('AUTH_KEY',         'testing-key-1');
          define('SECURE_AUTH_KEY',  'testing-key-2');
          define('LOGGED_IN_KEY',    'testing-key-3');
          define('NONCE_KEY',        'testing-key-4');
          define('AUTH_SALT',        'testing-salt-1');
          define('SECURE_AUTH_SALT', 'testing-salt-2');
          define('LOGGED_IN_SALT',   'testing-salt-3');
          define('NONCE_SALT',       'testing-salt-4');

          EOF


      - name: Start Nginx and PHP-FPM
        run: |
          # Start PHP-FPM
          sudo systemctl start php8.1-fpm
          sudo systemctl status php8.1-fpm --no-pager

          # Start Nginx
          sudo systemctl start nginx
          sudo systemctl status nginx --no-pager

          # Wait for services
          sleep 3

          # Test if site is accessible
          curl -f http://wooc-local-test-sitecom.local:8080 || (echo "âŒ Site not accessible" && exit 1)
          echo "âœ… Nginx and PHP-FPM started successfully"

      - name: Install WP-CLI
        run: |
          echo "=== Installing WP-CLI ==="
          curl -L -o wp-cli.phar https://github.com/wp-cli/wp-cli/releases/download/v2.10.0/wp-cli-2.10.0.phar

          if head -1 wp-cli.phar | grep -q "#!/usr/bin/env php"; then
            chmod +x wp-cli.phar
            sudo mv wp-cli.phar /usr/local/bin/wp
            echo "âœ… WP-CLI installed successfully"
          else
            echo "âŒ Downloaded file is not valid PHP"
            exit 1
          fi

          wp --version

      - name: Install WordPress
        run: |
          cd /tmp/wordpress
          wp core install \
            --url=http://wooc-local-test-sitecom.local:8080 \
            --title="E2E Test Site" \
            --admin_user=admin \
            --admin_password=admin \
            --admin_email=test@example.com \
            --allow-root

          echo "WordPress installed successfully"

          # Without a theme, wp_head() is not called and pixel code won't be injected
          wp theme install storefront --activate --allow-root
          echo "âœ… Storefront theme activated (classic theme with proper wp_head/wp_footer hooks)"
          wp plugin install woocommerce --activate --allow-root

          # Basic WooCommerce setup
          wp option update woocommerce_store_address "123 Test Street" --allow-root
          wp option update woocommerce_store_city "Test City" --allow-root
          wp option update woocommerce_default_country "US:CA" --allow-root
          wp option update woocommerce_store_postcode "12345" --allow-root
          wp option update woocommerce_currency "USD" --allow-root

      - name: Install Facebook for WooCommerce plugin
        run: |
          cd /tmp/wordpress

          # Use marketplace version if flag is true
          if [ "${{ inputs.use-marketplace-version }}" = "true" ]; then
            echo "Installing Facebook for WooCommerce from wordpress.org marketplace"
            wp plugin install facebook-for-woocommerce --version=dev --allow-root
          else
            echo "Installing Facebook for WooCommerce from local workspace"
            # Copy plugin files from the checked out repository root
            cp -r ${{ github.workspace }} wp-content/plugins/facebook-for-woocommerce/

            # Install Composer dependencies for the plugin
            cd wp-content/plugins/facebook-for-woocommerce
            if [ -f composer.json ]; then
              composer install --no-dev --optimize-autoloader
            fi
            cd /tmp/wordpress
          fi

          # Configure Facebook connection before activation
          wp option update wc_facebook_access_token "${{ secrets.FB_ACCESS_TOKEN }}" --allow-root
          wp option update wc_facebook_merchant_access_token "${{ secrets.FB_ACCESS_TOKEN }}" --allow-root
          wp option update wc_facebook_business_manager_id "${{ secrets.FB_BUSINESS_MANAGER_ID }}" --allow-root
          wp option update wc_facebook_external_business_id "${{ secrets.FB_EXTERNAL_BUSINESS_ID }}" --allow-root
          wp option update wc_facebook_product_catalog_id "${{ secrets.FB_PRODUCT_CATALOG_ID }}" --allow-root
          wp option update wc_facebook_has_connected_fbe_2 "yes" --allow-root
          wp option update wc_facebook_has_authorized_pages_read_engagement "yes" --allow-root
          wp option update wc_facebook_enable_product_sync "yes" --allow-root
          wp option update wc_facebook_page_id  "${{ secrets.FB_PAGE_ID }}" --allow-root
          wp option update wc_facebook_enable_server_to_server "yes" --allow-root
          wp option update wc_facebook_enable_pixel "yes" --allow-root
          wp option update wc_facebook_pixel_id "${{ secrets.FB_PIXEL_ID }}" --allow-root
          wp option update wc_facebook_enable_advanced_matching "yes" --allow-root
          wp option update wc_facebook_debug_mode yes --allow-root



          # CRITICAL FIX: Set facebook_config option (what the plugin actually reads)
          wp eval "
            \$config = array(
              'pixel_id' => '${{ secrets.FB_PIXEL_ID }}',
              'use_pii' => 1,
              'use_s2s' => true,
              'access_token' => '${{ secrets.FB_ACCESS_TOKEN }}'
            );
            update_option('facebook_config', \$config);
            \$saved = get_option('facebook_config');
            if (empty(\$saved['pixel_id'])) {
              echo 'âŒ FAILED to save pixel ID to facebook_config!' . PHP_EOL;
              exit(1);
            }
            echo 'âœ… facebook_config saved. Pixel ID: ' . \$saved['pixel_id'] . PHP_EOL;
          " --allow-root

          # Create debug.log file and make it writable
          touch wp-content/debug.log
          chmod 777 wp-content/debug.log
          echo "âœ… debug.log created and writable"

          # VERIFY wp-config.php has debug settings
          echo ""
          echo "=== Verifying wp-config.php Debug Settings ==="
          if grep -q "WP_DEBUG.*true" wp-config.php; then
            echo "âœ… WP_DEBUG is enabled"
          else
            echo "âŒ WP_DEBUG is NOT enabled!"
            exit 1
          fi

          if grep -q "WP_DEBUG_LOG" wp-config.php; then
            echo "âœ… WP_DEBUG_LOG is configured"
            grep "WP_DEBUG_LOG" wp-config.php | head -n 1
          else
            echo "âŒ WP_DEBUG_LOG is NOT configured!"
            exit 1
          fi

          if grep -q "ini_set.*error_log" wp-config.php; then
            echo "âœ… PHP error_log path is set"
            grep "ini_set.*error_log" wp-config.php | head -n 1
          else
            echo "âš ï¸  PHP error_log path is NOT explicitly set"
          fi

          # Test error_log is working
          echo ""
          echo "=== Testing error_log() function ==="
          wp eval "error_log('ğŸ§ª TEST: error_log() is working from WP-CLI');" --allow-root

          if [ -f wp-content/debug.log ] && grep -q "error_log() is working" wp-content/debug.log; then
            echo "âœ… error_log() writes to debug.log successfully"
            echo "   Content:"
            tail -n 1 wp-content/debug.log
          else
            echo "âŒ error_log() is NOT writing to debug.log!"
            echo "   This means our E2E logs won't work either!"
            exit 1
          fi

          # Test PHP can write to debug.log via web request
          echo ""
          echo "=== Testing error_log() via HTTP request ==="
          echo "<?php error_log('ğŸ§ª TEST: error_log() is working from HTTP request'); echo 'Test complete'; ?>" > wp-content/test-error-log.php

          curl -s http://localhost:8080/wp-content/test-error-log.php > /dev/null
          sleep 1

          if grep -q "error_log() is working from HTTP request" wp-content/debug.log; then
            echo "âœ… error_log() works from HTTP requests"
            echo "   Content:"
            tail -n 1 wp-content/debug.log
          else
            echo "âš ï¸  error_log() from HTTP might not work (could be buffering)"
          fi

          rm -f wp-content/test-error-log.php

          # Clear debug.log for fresh test run
          echo "" > wp-content/debug.log
          echo "âœ… debug.log cleared for fresh test run"

          # Activate the plugin (this triggers automatic sync)
          wp plugin activate facebook-for-woocommerce --allow-root

          # NO mu-plugin needed! API.php already loads Logger.php directly.
          echo "âœ… Plugin activated - CAPI logger built-in"

          # Create a customer (non-admin) user for testing
          # Pixel tracking excludes admin users by default!
          wp user create customer customer@test.com --role=customer --user_pass=Password@54321 --allow-root || echo "Customer user already exists"
          echo "âœ… Customer user created/verified"

          # Create test product for ViewContent/AddToCart tests
          wp eval "
            \$product = new WC_Product_Simple();
            \$product->set_name('TestP');
            \$product->set_slug('testp');
            \$product->set_regular_price('19.99');
            \$product->set_description('Test product for E2E tests');
            \$product->set_status('publish');
            \$product->set_catalog_visibility('visible');
            \$product->set_stock_status('instock');
            \$product->set_manage_stock(false);
            \$product_id = \$product->save();
            wp_set_object_terms(\$product_id, 'uncategorized', 'product_cat');
            echo 'âœ… Test product created. URL: ' . get_permalink(\$product_id) . PHP_EOL;
          " --allow-root

          # Test if we can reach Facebook endpoints at all
          echo ""
          echo "=== Testing Facebook Endpoint Connectivity ==="
          curl -I https://www.facebook.com/tr 2>&1 | head -n 5 || echo "âŒ Cannot reach facebook.com/tr"
          curl -I https://connect.facebook.net 2>&1 | head -n 5 || echo "âŒ Cannot reach connect.facebook.net"


      - name: Verify WordPress setup
        run: |
          cd /tmp/wordpress
          echo "=== WordPress Info ==="
          wp core version --allow-root
          echo "=== Active Plugins ==="
          wp plugin list --status=active --allow-root
          echo "=== Site URL ==="
          wp option get siteurl --allow-root

          # Test if site is accessible
          curl -f http://localhost:8080 || exit 1

      - name: Verify Facebook for WooCommerce setup
        run: |
          cd /tmp/wordpress
          echo "=== Facebook for WooCommerce Info ==="
          wp eval "
            if (function_exists('facebook_for_woocommerce')) {
                \$connection = facebook_for_woocommerce()->get_connection_handler();
                echo 'Connected: ' . (\$connection->is_connected() ? 'YES' : 'NO') . PHP_EOL;
                echo 'Access Token: ' . (\$connection->get_access_token() ? 'Present' : 'Missing') . PHP_EOL;
                echo 'External Business ID: ' . \$connection->get_external_business_id() . PHP_EOL;
                echo 'Business Manager ID: ' . \$connection->get_business_manager_id() . PHP_EOL;
                echo 'Pixel ID: ' . get_option('wc_facebook_pixel_id') . PHP_EOL;
                echo 'Pixel Enabled: ' . get_option('wc_facebook_enable_pixel') . PHP_EOL;
                echo 'S2S Enabled: ' . get_option('wc_facebook_enable_server_to_server') . PHP_EOL;
                echo 'Debug Mode: ' . get_option('wc_facebook_debug_mode') . PHP_EOL;

                // Check if pixel install is set
                \$pixel_install = get_option('wc_facebook_pixel_install_time');
                if (empty(\$pixel_install)) {
                    update_option('wc_facebook_pixel_install_time', time());
                    echo 'âœ… Set pixel install time' . PHP_EOL;
                }

                // Force initialize integration to trigger EventsTracker
                echo PHP_EOL . '=== Forcing Integration Initialization ===' . PHP_EOL;
                \$integration = facebook_for_woocommerce()->get_integration();
                echo 'Integration loaded: ' . (is_object(\$integration) ? 'YES' : 'NO') . PHP_EOL;
                echo 'Integration Pixel ID: ' . \$integration->get_facebook_pixel_id() . PHP_EOL;

                // Check EventsTracker
                \$reflection = new ReflectionClass(\$integration);
                \$property = \$reflection->getProperty('events_tracker');
                \$property->setAccessible(true);
                \$tracker = \$property->getValue(\$integration);
                echo 'EventsTracker instantiated: ' . (is_object(\$tracker) ? 'YES' : 'NO') . PHP_EOL;
            } else {
                echo 'Facebook plugin not loaded properly';
            }" --allow-root

          echo ""
          echo "=== Testing HTTP request to trigger init hook ==="
          curl -s http://localhost:8080 > /tmp/homepage.html

          echo "Checking if WordPress is loaded..."
          grep -q "wp-content" /tmp/homepage.html && echo "âœ… WordPress assets found" || echo "âŒ WordPress NOT loaded"

          echo "Checking if WooCommerce is loaded..."
          grep -q "woocommerce" /tmp/homepage.html && echo "âœ… WooCommerce assets found" || echo "âŒ WooCommerce NOT loaded"

          echo "Checking if theme header/footer are present..."
          grep -q "wp_head" /tmp/homepage.html && echo "âœ… wp_head marker found" || echo "âš ï¸  No wp_head marker"
          grep -q "wp_footer" /tmp/homepage.html && echo "âœ… wp_footer marker found" || echo "âš ï¸  No wp_footer marker"

          echo "Checking if pixel code exists in HTML..."
          if grep -q "fbq('init'" /tmp/homepage.html; then
            echo "âœ… fbq('init') FOUND"
            # Show the actual pixel code
            echo "   Pixel init code:"
            grep -A 2 "fbq('init'" /tmp/homepage.html | head -n 3
          else
            echo "âŒ fbq('init') NOT FOUND"
            # Check if fbq exists at all
            if grep -q "fbq" /tmp/homepage.html; then
              echo "   BUT 'fbq' string exists in HTML"
              grep "fbq" /tmp/homepage.html | head -n 5
            else
              echo "   âŒ NO 'fbq' string in HTML at all - plugin hooks not firing!"
            fi
          fi

          grep -q "track" /tmp/homepage.html && echo "âœ… fbq('track', 'PageView') FOUND" || echo "âŒ fbq('track', 'PageView') NOT FOUND"
          grep -qi "pageview" /tmp/homepage.html && echo "âœ… fbq('track', 'PageView') FOUND" || echo "âŒ fbq('track', 'PageView') NOT FOUND"
          grep -q "facebook.com/tr?id=" /tmp/homepage.html && echo "âœ… Pixel IMG tag FOUND" || echo "âŒ Pixel IMG tag NOT FOUND"

          echo ""
          echo "=== Checking actual HTML output size ==="
          wc -c /tmp/homepage.html
          head -n 50 /tmp/homepage.html

          # Check debug log for our E2E markers
          echo ""
          echo "=== Debug Log Output ==="
          if [ -f wp-content/debug.log ]; then
            echo "Debug log exists, checking for E2E markers..."
            grep "E2E_DEBUG" wp-content/debug.log || echo "âš ï¸ No E2E_DEBUG markers found in log"
          else
            echo "âš ï¸ Debug log doesn't exist yet"
          fi

      - name: Install Playwright
        run: |
          # Install in the WordPress plugin directory (where we'll run tests from)
          cd /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce
          npm install
          npx playwright install chromium
          npx playwright install-deps chromium


      - name: Debug captured-events directory
        run: |
          mkdir -p /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce/tests/e2e/captured-events
          chmod 777 /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce/tests/e2e/captured-events


      - name: Install Xvfb for headed browser
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Run E2E tests
        env:
          WORDPRESS_URL: http://wooc-local-test-sitecom.local:8080
          WP_CUSTOMER_USERNAME: admin
          WP_CUSTOMER_PASSWORD: admin
        run: |
          # Verify domain is accessible
          curl -I http://wooc-local-test-sitecom.local:8080 || echo "âš ï¸ Domain check failed, but continuing..."

          # SIMPLIFIED: Just create the directory where PHP writes
          # Both PHP and tests will use the SAME directory in the WordPress plugin
          EVENTS_DIR="/tmp/wordpress/wp-content/plugins/facebook-for-woocommerce/tests/e2e/captured-events"
          mkdir -p "$EVENTS_DIR"
          chmod 777 "$EVENTS_DIR"

          echo "âœ… Events directory created: $EVENTS_DIR"
          ls -la /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce/tests/e2e/ | grep captured

          # Run tests FROM the WordPress plugin directory (not workspace)
          cd /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce
          xvfb-run --auto-servernum npx playwright test --headed

      - name: Print debug.log (ALWAYS)
        if: always()
        run: |
          echo "=== FULL DEBUG LOG ==="
          if [ -f /tmp/wordpress/wp-content/debug.log ]; then
            cat /tmp/wordpress/wp-content/debug.log
          else
            echo "âš ï¸ No debug.log file found"
          fi

      - name: Check for PHP errors
        if: always()
        run: |
          echo "=== Checking for PHP errors ==="
          DEBUG_LOG_PATH="/tmp/wordpress/wp-content/debug.log"
          echo "Looking for debug.log at: $DEBUG_LOG_PATH"
          if [ -f "$DEBUG_LOG_PATH" ]; then
            echo "=== PHP Debug Log Found ==="
            echo "File size: $(stat -c%s "$DEBUG_LOG_PATH" 2>/dev/null || stat -f%z "$DEBUG_LOG_PATH" 2>/dev/null || echo 'unknown') bytes"
            cat "$DEBUG_LOG_PATH"
            echo ""
            echo "=== Checking for errors ==="
            if grep -i "fatal\|error" "$DEBUG_LOG_PATH"; then
              echo "âŒ PHP errors detected"
              exit 1
            else
              echo "âœ… No errors found in debug.log"
            fi
          else
            echo "âš ï¸  No debug log found at: $DEBUG_LOG_PATH"
            echo "Checking if directory exists:"
            ls -la /tmp/wordpress/wp-content/ || echo "Directory not found"
          fi

      - name: Find ALL debug.log files in the system
        if: always()
        run: |
          echo "=== ğŸ” SEARCHING FOR ALL debug.log FILES ==="
          echo "Starting comprehensive search..."
          echo ""

          # Search in common locations and workspace
          SEARCH_PATHS=(
            "/tmp/wordpress"
            "${{ github.workspace }}"
            "/home/runner/work"
            "/tmp"
            "/var/log"
          )

          echo "ğŸ“‚ Searching in specific paths:"
          for path in "${SEARCH_PATHS[@]}"; do
            if [ -d "$path" ]; then
              echo "  Searching: $path"
              find "$path" -name "debug.log" -type f 2>/dev/null | while read -r file; do
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… FOUND: $file"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "ğŸ“Š File info:"
                ls -lh "$file"
                echo ""
                echo "ğŸ“ Last 100 lines of content:"
                tail -n 100 "$file"
                echo ""
                echo "ğŸ” E2E-related logs (grep 'E2E'):"
                grep "E2E" "$file" || echo "  (No E2E markers found)"
                echo ""
              done
            fi
          done

          echo ""
          echo "=== ğŸ” WIDE SYSTEM SEARCH (may take a moment) ==="
          # Wider search from root, excluding common system dirs that would slow it down
          find / -name "debug.log" -type f \
            -not -path "/proc/*" \
            -not -path "/sys/*" \
            -not -path "/dev/*" \
            -not -path "/snap/*" \
            2>/dev/null | while read -r file; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… FOUND (system-wide): $file"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            ls -lh "$file"
            echo "Last 50 lines:"
            tail -n 50 "$file"
            echo ""
          done || echo "âš ï¸  System-wide search completed or had permission issues"

          echo ""
          echo "=== ğŸ” CHECKING captured-events DIRECTORY ==="
          EVENTS_DIRS=(
            "/tmp/wordpress/wp-content/plugins/facebook-for-woocommerce/tests/e2e/captured-events"
            "${{ github.workspace }}/tests/e2e/captured-events"
          )

          for dir in "${EVENTS_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "ğŸ“‚ Contents of: $dir"
              ls -lah "$dir"
              echo ""
              # Show content of any JSON files found
              find "$dir" -name "*.json" -type f | while read -r jsonfile; do
                echo "ğŸ“„ File: $jsonfile"
                cat "$jsonfile"
                echo ""
              done
            else
              echo "âŒ Directory not found: $dir"
            fi
          done

          echo ""
          echo "=== SEARCH COMPLETE ==="

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

      - name: Upload PHP logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: php-debug-logs
          path: /tmp/wordpress/wp-content/debug.log
          retention-days: 7

      - name: Upload test videos/screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-failures
          path: test-results/
          retention-days: 7
