name: PHP Unit Tests

on: [ push, pull_request ] # Run on all pushes and PRs

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  UnitTests:
    name: PHP unit tests - PHP ${{ matrix.php }}, WP ${{ matrix.wp-version }}, WC ${{ matrix.wc-version }}
    runs-on: ubuntu-latest
    env:
      WP_CORE_DIR: "/tmp/wordpress/src"
      WP_TESTS_DIR: "/tmp/wordpress/tests/phpunit"
    strategy:
      fail-fast: false
      matrix:
        php: [ 7.4, 8.3 ]
        wp-version: [ latest ]
        wc-version: [ latest ]

    steps:
      - name: Install SVN
        run: sudo apt-get install subversion -y

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Prepare PHP
        uses: woocommerce/grow/prepare-php@actions-v1
        with:
          php-version: "${{ matrix.php }}"
          coverage: xdebug

      - name: Prepare MySQL
        uses: woocommerce/grow/prepare-mysql@actions-v1

      - name: Install WP tests
        run: |
          chmod +x ./bin/install-wp-tests.sh
          ./bin/install-wp-tests.sh wordpress_test root root localhost ${{ matrix.wp-version }} ${{ matrix.wc-version }}

      - name: Run PHP unit tests with coverage
        id: phpunit
        run: |
          echo "üß™ Running PHP unit tests with coverage..."

          # Run tests once with both verbose output and coverage generation
          if ./vendor/bin/phpunit --verbose --coverage-clover=coverage.xml; then
            echo "‚úÖ All tests passed!"
            TEST_STATUS="passed"

            # Extract coverage summary from XML
            COVERAGE=$(php -r "
              if (file_exists('coverage.xml')) {
                \$xml = simplexml_load_file('coverage.xml');
                \$metrics = \$xml->project->metrics;
                \$covered = (int)\$metrics['coveredstatements'];
                \$total = (int)\$metrics['statements'];
                \$percentage = \$total > 0 ? round((\$covered / \$total) * 100, 2) : 0;
                echo \$percentage;
              } else {
                echo '0';
              }
            ")

            echo "coverage_summary=$COVERAGE" >> $GITHUB_OUTPUT
            echo "üìä Coverage: $COVERAGE%"
          else
            echo "‚ùå Some tests failed!"
            TEST_STATUS="failed"
            # Clean up any partial coverage file
            rm -f coverage.xml
            exit 1
          fi

          echo "test_status=$TEST_STATUS" >> $GITHUB_OUTPUT

      - name: Upload coverage reports
        if: steps.phpunit.outputs.test_status == 'passed'
        uses: actions/upload-artifact@v4
        with:
          name: php-coverage-report PHP - ${{ matrix.php }}, WP - ${{ matrix.wp-version }} , WC - ${{ matrix.wc-version }}
          path: coverage.xml
          retention-days: 30

      - name: Check coverage threshold
        if: steps.phpunit.outputs.test_status == 'passed'
        continue-on-error: true
        run: |
          COVERAGE="${{ steps.phpunit.outputs.coverage_summary }}"
          MIN_THRESHOLD=40

          echo "üìà Coverage: $COVERAGE%"
          echo "üéØ Threshold: $MIN_THRESHOLD%"

          if (( $(echo "$COVERAGE $MIN_THRESHOLD" | awk '{print ($1 >= $2)}') )); then
            echo "‚úÖ Coverage check passed!"
          else
            echo "‚ùå Coverage too low. Need $MIN_THRESHOLD%, got $COVERAGE%"
            exit 1
          fi

      - name: Run critical flows tests
        id: critical-tests
        run: |
          echo "üß™ Running critical flows tests..."

          # Run critical flows tests using dedicated config
          if ./vendor/bin/phpunit --configuration=phpunit-critical.xml.dist --verbose --coverage-clover=critical-coverage.xml; then
            echo "‚úÖ All critical flows tests passed!"
            CRITICAL_TEST_STATUS="passed"

            # Extract coverage summary for critical flows
            CRITICAL_COVERAGE=$(php -r "
              if (file_exists('critical-coverage.xml')) {
                \$xml = simplexml_load_file('critical-coverage.xml');
                \$metrics = \$xml->project->metrics;
                \$covered = (int)\$metrics['coveredstatements'];
                \$total = (int)\$metrics['statements'];
                \$percentage = \$total > 0 ? round((\$covered / \$total) * 100, 2) : 0;
                echo \$percentage;
              } else {
                echo '0';
              }
            ")

            echo "critical_coverage_summary=$CRITICAL_COVERAGE" >> $GITHUB_OUTPUT
            echo "üìä Critical flows coverage: $CRITICAL_COVERAGE%"
          else
            echo "‚ùå Critical flows tests failed!"
            CRITICAL_TEST_STATUS="failed"
            rm -f critical-coverage.xml
            exit 1
          fi

          echo "critical_test_status=$CRITICAL_TEST_STATUS" >> $GITHUB_OUTPUT

      - name: Check critical flows coverage threshold
        if: steps.critical-tests.outputs.critical_test_status == 'passed'
        continue-on-error: true
        run: |
          CRITICAL_COVERAGE="${{ steps.critical-tests.outputs.critical_coverage_summary }}"
          MIN_CRITICAL_THRESHOLD=20

          echo "üìà Critical flows coverage: $CRITICAL_COVERAGE%"
          echo "üéØ Critical flows threshold: $MIN_CRITICAL_THRESHOLD%"

          if (( $(echo "$CRITICAL_COVERAGE $MIN_CRITICAL_THRESHOLD" | awk '{print ($1 >= $2)}') )); then
            echo "‚úÖ Critical flows coverage check passed!"
          else
            echo "‚ùå Critical flows coverage too low. Need $MIN_CRITICAL_THRESHOLD%, got $CRITICAL_COVERAGE%"
            exit 1
          fi

      - name: Upload critical flows coverage reports
        if: steps.critical-tests.outputs.critical_test_status == 'passed'
        uses: actions/upload-artifact@v4
        with:
          name: critical-flows-coverage-report PHP - ${{ matrix.php }}, WP - ${{ matrix.wp-version }} , WC - ${{ matrix.wc-version }}
          path: critical-coverage.xml
          retention-days: 30
