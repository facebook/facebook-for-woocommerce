name: E2E Pixel & CAPI Tests

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install
      
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.0'
          extensions: mbstring, intl, mysqli
          coverage: none
      
      - name: Set up MySQL
        run: |
          sudo /etc/init.d/mysql start
          mysql -e 'CREATE DATABASE IF NOT EXISTS wordpress_test;' -uroot -proot
          mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root';" -uroot -proot
      
      - name: Install WP-CLI
        run: |
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
      
      - name: Set up WordPress
        run: |
          mkdir -p /tmp/wordpress
          wp core download --path=/tmp/wordpress --allow-root
          wp config create --path=/tmp/wordpress --dbname=wordpress_test --dbuser=root --dbpass=root --dbhost=127.0.0.1 --allow-root
          wp core install --path=/tmp/wordpress --url=http://localhost:8080 --title="Test Site" --admin_user=admin --admin_password=admin --admin_email=admin@example.com --skip-email --allow-root
          wp plugin install woocommerce --activate --path=/tmp/wordpress --allow-root
      
      - name: Copy plugin to WordPress
        run: |
          mkdir -p /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce
          cp -r . /tmp/wordpress/wp-content/plugins/facebook-for-woocommerce
      
      - name: Activate Facebook plugin
        run: |
          wp plugin activate facebook-for-woocommerce --path=/tmp/wordpress --allow-root
      
      - name: Configure Facebook plugin
        run: |
          wp option update wc_facebook_pixel_id "${{ secrets.FB_PIXEL_ID || '123456789' }}" --path=/tmp/wordpress --allow-root
          wp option update wc_facebook_access_token "${{ secrets.FB_ACCESS_TOKEN || 'test_token' }}" --path=/tmp/wordpress --allow-root
      
      - name: Create test products
        run: |
          # Create test product "Hoodie"
          wp wc product create --user=admin --name="Hoodie" --slug="hoodie" --type=simple --regular_price=45 --status=publish --path=/tmp/wordpress --allow-root
          
          # Create product category "Hoodies"
          wp term create product_cat "Hoodies" --slug=hoodies --path=/tmp/wordpress --allow-root
          
          # Assign product to category
          wp post term set $(wp post list --post_type=product --name=hoodie --format=ids --path=/tmp/wordpress --allow-root) product_cat hoodies --path=/tmp/wordpress --allow-root
      
      - name: Enable WordPress debugging
        run: |
          wp config set WP_DEBUG true --raw --path=/tmp/wordpress --allow-root
          wp config set WP_DEBUG_LOG true --raw --path=/tmp/wordpress --allow-root
          wp config set WP_DEBUG_DISPLAY false --raw --path=/tmp/wordpress --allow-root
      
      - name: Start PHP server
        run: |
          cd /tmp/wordpress
          php -S localhost:8080 &
          sleep 5
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run E2E tests
        env:
          WORDPRESS_URL: http://localhost:8080
          WORDPRESS_PATH: /tmp/wordpress
          WP_USERNAME: admin
          WP_PASSWORD: admin
        run: npm run test:e2e
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            tests/e2e/captured-events/
            /tmp/wordpress/wp-content/debug.log
          retention-days: 7
      
      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7
